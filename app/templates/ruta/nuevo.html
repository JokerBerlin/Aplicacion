{% extends "base.html" %}
{% block imports %}
<script type="text/javascript" src="/static/js/crearRutas.js"></script>
<script type="text/javascript">
$(document).ready(function(){
    var latCliente;
    var longCliente;

    $( "#id_nombre" ).focus();
    $( "#id_cliente" ).autocomplete({
        source: function (request, response) {
            var datos = {nombreCliente: $("#id_cliente").val()};
            var sendData = JSON.stringify(datos);
            $.ajax({
                type: "POST",
                dataType: "json",
                url: "/cliente/buscar/",
                data: sendData,
                contentType: "application/json; charset=utf-8",
                async: false,
                cache: false,
                CrossDomain: true,

                success: function (result) {
                var ListasClientes = result['clientes'];
                response($.map(ListasClientes, function (item) {
                                        
                    return {
                        label: item.nombre,
                        idcliente: item.nombre,
                        direccion: item.direccion,
                        latitud: item.latitud,
                        longitud: item.longitud,
                        Id: item.id
                        };
                    }));
                }
            });
        },

        minLength: 1,

        select: function (event, ui) {
            $.data(document.body, 'idcliente', ui.item.Id);//guardar el id en memoria el $.data guarda en memoria
            // var direccion=  ui.item.direccion;

            var iDPro = ui.item.Id;
            
            latCliente = ui.item.latitud;
            longCliente = ui.item.longitud;

            $('#latitud').val(latCliente);
            $('#longitud').val(longCliente);
        
        }


    });

});

var mapa, infoWindow, ds, dr;
var markers = [];

function addMarker(config) {
  var marker = new google.maps.Marker({
    position: config.position,
    map: mapa,
    draggable: false
  });
  markers.push(marker)
}

function initMap() {
  mapa = new google.maps.Map(document.getElementById('mapa'), {
    center: {lat: -13.1587800, lng: -74.2232100},
    zoom: 17
  });

  infoWindow = new google.maps.InfoWindow;

  ds = new google.maps.DirectionsService();
  dr = new google.maps.DirectionsRenderer({map: mapa, suppressMarkers: true});
  
  // Try HTML5 geolocation.
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };

      var config = {
        position: pos
      };

      var marker = new google.maps.Marker({
          position: config.position,
          map: mapa,
          draggable: true
      })
      markers.push(marker);
      
      mapa.setCenter(pos);
    
    }, function() {
      handleLocationError(true, infoWindow, mapa.getCenter());
    });
  } else {
    // Browser doesn't support Geolocation
    handleLocationError(false, infoWindow, mapa.getCenter());
  }
}

function handleLocationError(browserHasGeolocation, infoWindow, pos) {
  infoWindow.setPosition(pos);
  infoWindow.setContent(browserHasGeolocation ?
                        'Error: TEl servicio de geolocalizacion no funciono.' :
                        'Error: Tu navegador no posee servicio de geolocalizacion, utiliza Google Chrome en su lugar.');
  infoWindow.open(mapa);
}

</script>

 <style>
    ul.ui-autocomplete {
        z-index: 1100;
    }
    #content{
        position: absolute;
        min-height: 50%;
        width: 80%;
        top: 20%;
        left: 5%;
    }

    .selected{
        cursor: pointer;
    }
    .selected:hover{
        background-color: #0585C0;
        color: white;
    }
    .seleccionada{
        background-color: #0585C0;
        color: white;
    }
</style>
{% endblock %}


{% block title %}
Nueva Ruta
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-sm-12">
            <div class="white-box">
                <h3 class="box-title">Nueva Ruta</h3>

            <!-- <form action = '' method="POST" enctype="multipart/form-data">
                 {% csrf_token %} -->
                 <ul>
                    <label for="id_nombre">Nombre:</label>
                    <br>
                    <input type="text" name="id_nombre" id="id_nombre" placeholder="Nombre Ruta..." required="" class="form-control" maxlength="45">
                    <label for="id_nombre">Cliente:</label>
                    <br>
                    <input type="text" name="id_cliente" id="id_cliente" placeholder="Nombre Cliente..." class="form-control" maxlength="45">
                    
                    <br>
                    <label for="latitud">Latitud:</label>
                    <br>
                    <input type="text" name="direccion" id="latitud" required="" class="form-control" disabled>
                    
                    <label for="longitud">Longitud:</label> 
                    <br>
                    <input type="number" name="precio" id="longitud" required="" class="form-control" disabled>
                    <br>

                    <a id="bt_add" class="btn btn-success">Agregar</a>
                    <a id="bt_del" class="btn btn-warning">Eliminar</a>
                    <button id="bt_delall" class="btn btn-danger">Eliminar todo</button>
            
                    <div class="row">
                        <div class="form-group">
                            <label ><center>Concepto Operación</center></label>
                            <table id="tabla" class="table table-bordered">
                            <thead>
                                <tr>
                                    <td>Nº</td>
                                    <td>Nombre</td>
                                    <td>Cliente</td>
                                    <td>Longitud</td>
                                    <td>Latitud</td>

                                </tr>
                            </thead>
                            </table>
                            <br>
                        </div>
                            
                       

                    </div>
                        <button id="bt_GenerarRuta" class="btn btn-success">Generar Ruta</button>
                    <div class="row">
                        <div class="form-group">
                            <div class="col-sm-8 col-md-8 col-lg-6">
                                <div id="tabs" style="display:none;">
                                    <table id="listaProducto"></table>
                                    <div id="pagerlistaProducto"  style="text-align: center;"></div>
                                </div>
                            </div>

                            <div class="col-sm-2 col-md-2 col-lg-4">

                            </div>
                        </div>
                    </div>


                       <h4 class="box-title">Geolocalizacion cliente</h4>
                    <div id="mapa" style="position: relative;overflow: hidden;height: 500px;">
                
                        <br>
                        <script async defer
                        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA94LBsliF6TX_7XT76lfJAopVP_h2RkkU&callback=initMap">
                        </script>

            </div>
            </ul>
        <!-- </form> -->

                      <br>
              </div>      
    </div>  
{% endblock %}
