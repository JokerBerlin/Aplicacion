{% extends "base.html" %}
{% block imports %}

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA94LBsliF6TX_7XT76lfJAopVP_h2RkkU&callback=initMap"></script>
<script type="text/javascript" src="/static/js/listarRuta.js"></script>
<script type="text/javascript">
window.onload = function() {    
    coordenadas.forEach(element => {
        // console.log(element);
        pos = {
            lat: parseFloat(element.lat),
            lng: parseFloat(element.lng)
        };
    
        config = {
            position: pos
        };
    
        addMarker(config)
    });
    
    var coords = Array();
    
    for (let i = 0; i < markers.length; i++) {
        const marker = markers[i];
        const coord = {lat: marker.position.lat(), lng: marker.position.lng()};
        coords.push(coord);
    }
    
    var waypts = Array();
    if (markers.length > 2) {
        for (let i = 1; i < markers.length - 1; i++) {
            waypts.push({
                location: markers[i].position,
                stopover: true
            })        
        }
    } else {
        waypts = []
    }
    const origen = markers[0].position;
    const destino = markers[markers.length - 1].position;

    if (waypts.length > 0) {
        ds.route({
            origin: origen,
            destination: destino,
            waypoints: waypts,
            optimizeWaypoints: true,
            travelMode: 'DRIVING',
        }, function(response, status) {
            if (status === 'OK') {
                dr.setDirections(response);
            } else {
                alert('Error' + status);
            }
        })
    } else {
        ds.route({
            origin: origen,
            destination: destino,
            optimizeWaypoints: true,
            travelMode: 'DRIVING',
        }, function(response, status) {
            if (status === 'OK') {
                dr.setDirections(response);
            } else {
                alert('Error' + status);
            }   
        })
    }

}
var coordenadas = {{ coordenadas|safe }};
var mapa, infoWindow, ds, dr;
var markers = [];

function addMarker(config) {
  var marker = new google.maps.Marker({
    position: config.position,
    map: mapa,
    draggable: false
  });
  markers.push(marker)
}

function initMap() {
  mapa = new google.maps.Map(document.getElementById('mapa'), {
    center: {lat: -13.1587800, lng: -74.2232100},
    zoom: 17
  });

  infoWindow = new google.maps.InfoWindow;

  ds = new google.maps.DirectionsService();
  dr = new google.maps.DirectionsRenderer({map: mapa, suppressMarkers: true});
  
  // Try HTML5 geolocation.
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };

      var config = {
        position: pos
      };

      var marker = new google.maps.Marker({
          position: config.position,
          map: mapa,
          draggable: true
      })
      markers.push(marker);      
      mapa.setCenter(pos);
    
    }, function() {
      handleLocationError(true, infoWindow, mapa.getCenter());
    });
  } else {
    // Browser doesn't support Geolocation
    handleLocationError(false, infoWindow, mapa.getCenter());
  }
}

function handleLocationError(browserHasGeolocation, infoWindow, pos) {
  infoWindow.setPosition(pos);
  infoWindow.setContent(browserHasGeolocation ?
                        'Error: El servicio de geolocalizacion no funciono.' :
                        'Error: Tu navegador no posee servicio de geolocalizacion, utiliza Google Chrome en su lugar.');
  infoWindow.open(mapa);
}

</script>
{% endblock %}

{% block title %}
Información  detallada de Ruta
{% endblock %}

{% block content %}
	<div class="row">
        <div class="col-sm-12">
            <div class="white-box">
                <h3 class="box-title">Datos de la ruta {{oRuta.nombre}}</h3>
			<div>
				<table id="tCamiones"  class="table">
					<tr>
						<td>Nombre: </td>
						<td>{{ oRuta.nombre }}</td>
					</tr>
					<tr>
						<td>Clientes: </td>
						<td>
							{% for oRutas in oRuta.clientes.all %}
								 {{ oRutas.nombre }}<br>
                            {% endfor %}
                        </td>
					</tr>
					<tr>
						<td>Dirección</td>
						<td>{% for oRutas in oRuta.clientes.all %}
									 {{ oRutas.direccion }}<br>
                                {% endfor %}
                        </td>
                    </tr>
					<tr>
						<td>Fecha</td>
						<td>{{ oRuta.fecha}}</td>
					</tr>
				</table>
        <ul>
					
					<h4 class="box-title">Geolocalizacion cliente</h4>
            <div id="mapa" style="position: relative;overflow: hidden;height: 300px;">
        
              <br>

            </div>
				</ul>
			</div>
			</div>

	    </div>
    </div>

{% endblock %}
